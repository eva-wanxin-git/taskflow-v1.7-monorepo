# 🎯 前端对话历史库 - 快速启动指南

**问题**: 前端Dashboard显示"暂无会话"  
**原因**: API服务未启动或前端未连接到API  
**解决**: 按以下步骤启动API并刷新前端

---

## ✅ 3步快速启动

### 第1步: 启动API服务

```bash
cd taskflow-v1.7-monorepo/apps/api
python start_api.py
```

**预期输出**:
```
INFO:     Uvicorn running on http://127.0.0.1:8800
```

### 第2步: 刷新Dashboard浏览器

在浏览器中重新加载Dashboard：
```
按 Ctrl+F5 (Windows) 或 Cmd+Shift+R (Mac)
```

或者点击**清除缓存**按钮（如果有的话）

### 第3步: 验证前端连接

打开浏览器的**开发者工具** (F12)，查看**Console**标签：

✅ **成功情况**:
```
[API已连接] 加载了 3 个会话
```

❌ **失败情况**:
```
❌ 无法加载会话数据
请确保API服务已启动: http://localhost:8800
```

---

## 🔧 故障排查

### 问题1: 前端仍显示"暂无会话"

**原因**: API服务未启动

**解决**:
```bash
# 在另一个终端启动API
cd taskflow-v1.7-monorepo/apps/api
python start_api.py --port 8800
```

### 问题2: 开发者工具显示CORS错误

**错误消息**: 
```
Access to XMLHttpRequest blocked by CORS policy
```

**解决**: 
1. 确保API已启用CORS (v1.7 API已默认启用)
2. 检查API是否真的在运行 (curl http://localhost:8800/api/health)

### 问题3: 前端显示"无法加载会话数据"错误

**可能原因**:
- API服务未启动
- API地址错误
- 防火墙阻止

**解决**:
```bash
# 检查API是否运行
curl http://localhost:8800/api/health

# 如果返回200和healthy，说明API正常
# 如果返回Connection refused，说明API未启动
```

---

## 📊 工作流程

```
┌─────────────────────────────────────────────────┐
│  第1步: 启动API服务                              │
│  $ python start_api.py                          │
│  http://localhost:8800 (API就绪)                │
└────────────────┬────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────┐
│  第2步: 刷新Dashboard                           │
│  Ctrl+F5 (Windows) / Cmd+Shift+R (Mac)         │
│  前端JavaScript加载                             │
└────────────────┬────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────┐
│  第3步: 前端连接API                             │
│  fetch('http://localhost:8800/api/conversations')
│  获取会话数据                                    │
└────────────────┬────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────┐
│  显示对话历史库                                  │
│  ✅ 会话列表                                    │
│  ✅ 会话详情                                    │
│  ✅ 搜索过滤                                    │
└─────────────────────────────────────────────────┘
```

---

## 🚀 完整启动脚本 (推荐)

### Windows用户

创建 `启动前端对话历史库.bat`:

```batch
@echo off
echo [*] 启动API服务...
start /d "apps\api" python start_api.py --port 8800

echo [*] 等待API启动...
timeout /t 3

echo [✓] API已启动
echo [*] 打开浏览器...
start http://localhost:8877

echo [✓] Dashboard已打开，请按 Ctrl+F5 刷新页面
pause
```

### Linux/Mac用户

创建 `启动前端对话历史库.sh`:

```bash
#!/bin/bash

echo "[*] 启动API服务..."
cd apps/api
python start_api.py --port 8800 &
API_PID=$!

echo "[*] 等待API启动..."
sleep 3

echo "[✓] API已启动 (PID: $API_PID)"
echo "[*] Dashboard应该已经在运行"
echo "[✓] 请在浏览器中按 Cmd+Shift+R 刷新页面"
echo ""
echo "按 Ctrl+C 停止服务"

wait $API_PID
```

---

## 📋 前端代码修改

前端已更新为支持API调用：

**文件**: `apps/dashboard/src/industrial_dashboard/templates.py`  
**函数**: `loadConversations()`

**工作流程**:
1. ✅ 尝试从API加载 (`http://localhost:8800/api/conversations`)
2. ✅ 如果API不可用，回退到本地JSON文件
3. ✅ 自动处理API响应格式和本地JSON格式
4. ✅ 显示清晰的错误信息

**代码变更**:
```javascript
// 新增: 从API加载
const response = await fetch('http://localhost:8800/api/conversations', {
    method: 'GET',
    headers: {'Content-Type': 'application/json'},
    timeout: 5000
});

// 新增: 优雅降级
if (data.success !== undefined) {
    // API格式
    conversationsData = { sessions: data.sessions || [] };
} else {
    // 本地JSON格式
    conversationsData = data;
}
```

---

## 🔍 验证前端连接

### 方法1: 浏览器开发者工具

```
1. 按 F12 打开开发者工具
2. 切换到 "Console" 标签
3. 查看日志输出
4. 应该看到: "加载了 X 个会话"
```

### 方法2: 网络标签

```
1. 按 F12 打开开发者工具
2. 切换到 "Network" 标签
3. 刷新页面
4. 找到 "conversations" 请求
5. 应该返回 200 状态码
```

### 方法3: curl命令

```bash
# 验证API是否响应
curl http://localhost:8800/api/conversations

# 应该返回类似:
{
  "success": true,
  "sessions": [
    {
      "session_id": "session-001",
      "title": "会话标题",
      ...
    }
  ],
  "count": 3,
  "timestamp": "2025-11-18T23:45:00"
}
```

---

## ⚙️ 配置说明

### API地址配置

如果你的API在其他地址（不是localhost:8800），修改：

**文件**: `apps/dashboard/src/industrial_dashboard/templates.py`  
**位置**: `loadConversations()` 函数内

```javascript
// 修改这一行
const response = await fetch('http://localhost:8800/api/conversations', {
    // 改为你的API地址
    // const response = await fetch('http://your-api-address:port/api/conversations', {
```

### 超时配置

如果网络较慢，可以增加超时时间：

```javascript
response = await fetch('http://localhost:8800/api/conversations', {
    method: 'GET',
    headers: {'Content-Type': 'application/json'},
    timeout: 10000  // 改为 10000ms (10秒)
});
```

---

## 📝 调试技巧

### 1. 查看前端日志

在浏览器Console中输入：

```javascript
// 查看会话数据
console.log(conversationsData);

// 查看当前选中的会话
console.log(selectedSessionId);

// 重新加载会话
loadConversations();
```

### 2. 查看API响应

```javascript
// 在浏览器Console中测试API
fetch('http://localhost:8800/api/conversations')
    .then(r => r.json())
    .then(data => console.log(JSON.stringify(data, null, 2)))
    .catch(e => console.error('API错误:', e));
```

### 3. 检查网络请求

```bash
# 使用curl测试API
curl -v http://localhost:8800/api/conversations

# 查看详细的HTTP头和响应
curl -i http://localhost:8800/api/conversations
```

---

## 📚 相关文档

- 📖 [API完整指南](./apps/api/docs/conversations-api-guide.md)
- 📊 [集成完成报告](./✅INTEGRATE-002-会话管理API集成完成报告.md)
- 🎯 [快速参考卡](./🎯INTEGRATE-002-快速参考卡.txt)

---

## 🎉 成功标志

✅ **前端已正确连接到API**，当你看到：

1. Dashboard的"对话历史库"Tab下显示会话列表
2. 浏览器Console没有错误消息
3. Network标签显示`/api/conversations`请求返回200
4. 能看到"共X个会话"的统计

---

## 💡 常见问题

**Q: 为什么要启动API?**  
A: 对话数据现在存储在API后端，前端需要通过API调用来获取数据。

**Q: 能否不启动API，直接用本地文件?**  
A: 可以！前端已实现自动降级，如果API不可用会自动使用本地JSON文件。

**Q: 会话数据保存在哪里?**  
A: 默认保存在 `automation-data/architect-conversations.json`

**Q: 如何添加新会话?**  
A: 通过API端点: `POST /api/conversations`

**Q: 如何修改API地址?**  
A: 在 `templates.py` 的 `loadConversations()` 函数中修改URL。

---

**最后更新**: 2025-11-18  
**状态**: ✅ 前端API集成完成

