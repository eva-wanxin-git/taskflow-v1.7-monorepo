# 📖 REQ-011: Dashboard动态进度计算 - 验证指南

## 🚀 快速验证步骤

### 1️⃣ 运行自动测试（推荐）

```bash
# 进入项目目录
cd taskflow-v1.7-monorepo

# 运行单元测试
python -m pytest tests/test_progress_calculation.py -v

# 运行集成测试
python test_dashboard_progress.py
```

**预期结果**:
- 单元测试：5/5 通过 ✅
- 集成测试：显示当前进度统计（如28%，11/40 tasks）

---

### 2️⃣ 启动Dashboard验证

```bash
# 进入项目目录
cd taskflow-v1.7-monorepo

# 启动Dashboard
python apps/dashboard/start_dashboard.py
```

**访问地址**: http://127.0.0.1:8877

---

### 3️⃣ 检查Dashboard显示

打开浏览器访问Dashboard，检查以下内容：

#### ✅ 整体进度区域
- **位置**: 页面顶部中央
- **显示内容**:
  - 大数字显示进度百分比（如：**28%**）
  - "DONE" 标签
  - 任务统计（如：**11/40 tasks**）

#### ✅ 进度条可视化
- **位置**: 整体进度下方的时间轴
- **显示效果**: 
  - 蓝色进度条宽度 = 进度百分比
  - 动态调整（完成任务后自动更新）

#### ✅ 统计卡片
- **总任务数**: 显示所有任务数量
- **待处理**: pending状态任务数
- **进行中**: in_progress状态任务数
- **已完成**: completed状态任务数

---

### 4️⃣ 验证自动刷新

1. **保持Dashboard页面打开**
2. **在另一个终端修改任务状态**:
   ```bash
   cd taskflow-v1.7-monorepo
   python -c "import sqlite3; conn = sqlite3.connect('database/data/tasks.db'); conn.execute('UPDATE tasks SET status=\"completed\" WHERE id=\"REQ-011\"'); conn.commit(); conn.close(); print('任务状态已更新')"
   ```
3. **观察Dashboard**:
   - 等待最多5秒
   - 进度百分比自动更新
   - 任务统计自动更新
   - 进度条宽度自动调整

---

## 🔍 详细验证清单

### 后端API验证

```bash
# 测试API端点
curl http://127.0.0.1:8877/api/stats

# 预期返回JSON格式:
# {
#   "total_tasks": 40,
#   "pending_tasks": 25,
#   "in_progress_tasks": 0,
#   "completed_tasks": 11,
#   "review_tasks": 0,
#   "failed_tasks": 0
# }
```

### 数据库查询验证

```bash
cd taskflow-v1.7-monorepo
python -c "
import sqlite3
conn = sqlite3.connect('database/data/tasks.db')
cursor = conn.cursor()
cursor.execute('SELECT COUNT(*) FROM tasks')
total = cursor.fetchone()[0]
cursor.execute('SELECT COUNT(*) FROM tasks WHERE status=\"completed\"')
completed = cursor.fetchone()[0]
progress = round((completed/total)*100) if total > 0 else 0
print(f'总任务: {total}, 已完成: {completed}, 进度: {progress}%')
conn.close()
"
```

### 前端计算验证

打开浏览器开发者工具（F12），在Console中执行：

```javascript
// 手动触发数据加载
loadData();

// 查看当前进度
console.log('进度:', document.getElementById('progressPercent').textContent);
console.log('任务统计:', document.getElementById('progressTasksCount').textContent);
```

---

## 📊 预期结果对照表

| 检查项 | 预期结果 | 验证方法 |
|-------|---------|---------|
| 总任务数 | ≥ 40 | 查看Dashboard统计卡片 |
| 已完成数 | ≥ 11 | 查看Dashboard统计卡片 |
| 进度百分比 | 0-100% | 查看"整体进度"区域 |
| 任务统计格式 | "X/Y tasks" | 查看进度百分比下方 |
| 进度条宽度 | = 进度% | 查看时间轴蓝色区域 |
| 自动刷新 | 每5秒 | 观察页面自动更新 |
| API响应 | < 100ms | 浏览器Network面板 |

---

## 🐛 常见问题排查

### 问题1: 进度显示为0%
**可能原因**: 数据库中没有已完成的任务

**解决方案**:
```bash
# 手动完成一个任务测试
python -c "
import sqlite3
conn = sqlite3.connect('taskflow-v1.7-monorepo/database/data/tasks.db')
conn.execute('UPDATE tasks SET status=\"completed\" LIMIT 1')
conn.commit()
conn.close()
print('已完成一个任务')
"
```

### 问题2: 看不到任务统计
**可能原因**: 浏览器缓存

**解决方案**:
- 使用 `Ctrl + Shift + R` 强制刷新
- 或清除浏览器缓存

### 问题3: 进度不自动更新
**可能原因**: JavaScript错误

**解决方案**:
- 打开开发者工具（F12）查看Console错误
- 检查Network面板是否有请求失败

### 问题4: API返回错误
**可能原因**: 数据库文件不存在

**解决方案**:
```bash
# 检查数据库文件
ls -lh taskflow-v1.7-monorepo/database/data/tasks.db

# 如果不存在，运行初始化
cd taskflow-v1.7-monorepo
python database/migrations/migrate.py init
```

---

## 📸 截图参考

Dashboard应该显示类似以下内容：

```
┌─────────────────────────────────────────────────────────┐
│  任务所·FLOW v1.7                                        │
│  企业级AI任务中枢 | 多项目支持 + 智能端口管理              │
├─────────────────────────────────────────────────────────┤
│  [ 总任务: 40 ]  [ 待处理: 25 ]  [ 已完成: 11 ]        │
│                                                           │
│  ◉ 整体进度                                              │
│     ┌─────────────┐                                      │
│     │    28%      │  DONE                                │
│     │ 11/40 tasks │  ← 新增的任务统计显示                │
│     └─────────────┘                                      │
│                                                           │
│  ─────────────────●───────────────────────────           │
│  ████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░             │
│  └─ 28%宽度的进度条 ────────────────────────┘            │
└─────────────────────────────────────────────────────────┘
```

---

## ✅ 验收清单

在提交给架构师审查前，请确认以下所有项：

- [ ] 单元测试全部通过 (5/5)
- [ ] 集成测试输出正确
- [ ] Dashboard能正常启动
- [ ] 进度百分比显示正确
- [ ] 任务统计显示格式正确 (X/Y tasks)
- [ ] 进度条宽度正确反映进度
- [ ] 每5秒自动刷新
- [ ] API返回正确的JSON数据
- [ ] 修改任务状态后进度自动更新
- [ ] 无JavaScript控制台错误
- [ ] 无浏览器缓存问题

---

## 📞 获取帮助

如果验证过程中遇到问题：

1. **查看日志**: 检查终端输出的错误信息
2. **查看文档**: 阅读完成报告中的"风险注意事项"
3. **运行诊断**: 执行 `test_dashboard_progress.py` 查看详细输出
4. **联系架构师**: 提供完整的错误信息和截图

---

**验证指南版本**: 1.0  
**最后更新**: 2025-11-18  
**适用版本**: 任务所·Flow v1.7

