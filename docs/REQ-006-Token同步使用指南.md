# ğŸ“Š REQ-006: Tokenå®æ—¶åŒæ­¥ - ä½¿ç”¨æŒ‡å—

**åŠŸèƒ½**: Tokenæ˜¾ç¤ºå‡†ç¡®å®æ—¶åŒæ­¥  
**ä¼˜å…ˆçº§**: P1  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**å®Œæˆæ—¥æœŸ**: 2025-11-18

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†å¤šç§TokenåŒæ­¥æ–¹å¼ï¼Œç¡®ä¿Dashboardä¸Šçš„Tokenä½™é‡æ˜¾ç¤ºå‡†ç¡®ã€å®æ—¶ï¼š

1. **Dashboard UIåŒæ­¥** - ç‚¹å‡»æŒ‰é’®å¿«é€ŸåŒæ­¥
2. **å¿«æ·è„šæœ¬åŒæ­¥** - åŒå‡».batæ–‡ä»¶ä¸€é”®åŒæ­¥
3. **å‘½ä»¤è¡Œå·¥å…·** - Python CLIå·¥å…·
4. **è‡ªåŠ¨ä¼°ç®—** - æ™ºèƒ½ä¼°ç®—Tokenæ¶ˆè€—

---

## ğŸ¯ æ–¹æ³•1ï¼šDashboard UIåŒæ­¥ï¼ˆæ¨èï¼‰

### æ­¥éª¤

1. **æ‰“å¼€Dashboard**
   ```bash
   cd taskflow-v1.7-monorepo
   python apps/dashboard/start_dashboard.py
   ```

2. **æŸ¥çœ‹CursorçŠ¶æ€æ **
   - åœ¨Cursorå³ä¸‹è§’çŠ¶æ€æ æ‰¾åˆ°Tokenæ•°å­—
   - ä¾‹å¦‚ï¼š`350,000 tokens used`
   - é€‰ä¸­æ•°å­—å¹¶å¤åˆ¶ï¼ˆCtrl+Cï¼‰

3. **ç‚¹å‡»åŒæ­¥æŒ‰é’®**
   - Dashboardä¸­æ‰¾åˆ° "â–¸ Tokenä½™é‡" 
   - ç‚¹å‡»æ—è¾¹çš„ **"ğŸ”„ åŒæ­¥"** æŒ‰é’®
   - åœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­ç²˜è´´Tokenå€¼
   - ï¼ˆå¯é€‰ï¼‰å¡«å†™äº‹ä»¶æè¿°
   - ç‚¹å‡» **"âœ… åŒæ­¥"**

4. **æŸ¥çœ‹ç»“æœ**
   - å³ä¸Šè§’ä¼šæ˜¾ç¤ºæˆåŠŸæç¤º
   - Tokenä½™é‡ç«‹å³æ›´æ–°
   - äº‹ä»¶æµä¸­è®°å½•åŒæ­¥äº‹ä»¶

### æ”¯æŒçš„æ ¼å¼

- `350000` - çº¯æ•°å­—
- `350,000` - å¸¦é€—å·
- `350 000` - å¸¦ç©ºæ ¼
- `350K` - å¸¦Kåç¼€
- `35ä¸‡` - ä¸­æ–‡å•ä½

---

## ğŸš€ æ–¹æ³•2ï¼šå¿«æ·è„šæœ¬åŒæ­¥ï¼ˆæœ€å¿«ï¼‰

### å¿«é€ŸåŒæ­¥ï¼ˆå‰ªè´´æ¿ï¼‰

1. **åœ¨Cursorä¸­å¤åˆ¶Tokenå€¼**
   - é€‰ä¸­çŠ¶æ€æ çš„Tokenæ•°å­—
   - Ctrl+C å¤åˆ¶

2. **è¿è¡Œè„šæœ¬**
   - åŒå‡» `ğŸ”„å¿«é€ŸåŒæ­¥Token.bat`
   - æŒ‰ä»»æ„é”®å¼€å§‹
   - è‡ªåŠ¨ä»å‰ªè´´æ¿è¯»å–å¹¶åŒæ­¥

3. **æŸ¥çœ‹ç»“æœ**
   ```
   âœ… åŒæ­¥æˆåŠŸï¼
      Token: 350,000
      ä½¿ç”¨ç‡: 35.0%
   ```

### æ‰‹åŠ¨å½•å…¥

1. **è¿è¡Œè„šæœ¬**
   - åŒå‡» `ğŸ”¢æ‰‹åŠ¨å½•å…¥Token.bat`

2. **è¾“å…¥å€¼**
   ```
   è¯·è¾“å…¥å½“å‰Tokenå€¼: 350000
   äº‹ä»¶æè¿° (å¯é€‰ï¼ŒæŒ‰å›è½¦è·³è¿‡): å®Œæˆæ¶æ„è®¾è®¡
   ```

3. **å®Œæˆ**
   ```
   âœ… Tokenå·²æ›´æ–°: 350,000 / 1,000,000 (35.0%)
      æœ¬æ¬¡å¢é‡: 15,000 tokens
   ```

### æŸ¥çœ‹çŠ¶æ€

- åŒå‡» `ğŸ“ŠæŸ¥çœ‹TokençŠ¶æ€.bat`
- æ˜¾ç¤ºå½“å‰ä½¿ç”¨æƒ…å†µ

---

## ğŸ’» æ–¹æ³•3ï¼šå‘½ä»¤è¡Œå·¥å…·

### å®‰è£…ä¾èµ–

```bash
cd taskflow-v1.7-monorepo
pip install tiktoken pyperclip
```

### å‘½ä»¤

#### 1. å¿«æ·åŒæ­¥ï¼ˆå‰ªè´´æ¿ï¼‰

```bash
python packages/shared-utils/token_sync.py quick
```

#### 2. æ‰‹åŠ¨è®°å½•

```bash
python packages/shared-utils/token_sync.py record 350000 "å®Œæˆæ¶æ„è®¾è®¡"
```

#### 3. æŸ¥çœ‹çŠ¶æ€

```bash
python packages/shared-utils/token_sync.py status
```

è¾“å‡ºï¼š
```
ğŸ“Š Tokenä½¿ç”¨æƒ…å†µ
   å·²ä½¿ç”¨: 350,000 tokens
   æ€»é¢åº¦: 1,000,000 tokens
   ä½¿ç”¨ç‡: 35.0%
   å‰©ä½™: 650,000 tokens
   ä¼šè¯æ•°: 15
   æ›´æ–°æ—¶é—´: 2025-11-18T20:30:00
```

#### 4. è‡ªåŠ¨ä¼°ç®—å¯¹è¯

```bash
python packages/shared-utils/token_sync.py estimate "ç”¨æˆ·æ¶ˆæ¯" "AIå›å¤"
```

---

## ğŸ¤– æ–¹æ³•4ï¼šç¼–ç¨‹æ¥å£

### Python API

```python
from packages.shared_utils.token_sync import TokenSyncManager

# åˆå§‹åŒ–
manager = TokenSyncManager()

# å¿«æ·è®°å½•
result = manager.quick_record(350000, "å®Œæˆæ¶æ„è®¾è®¡")
print(f"æ€»ä½¿ç”¨: {result['total_used']}")

# è‡ªåŠ¨è®°å½•å¯¹è¯
result = manager.auto_record_conversation(
    user_message="è¯·å¸®æˆ‘å®ç°TokenåŒæ­¥åŠŸèƒ½",
    assistant_message="å¥½çš„ï¼Œæˆ‘ä¼šåˆ›å»º...",
    event="å¼€å‘TokenåŒæ­¥",
    conversation_id="session-001"
)

# è·å–å½“å‰ä½¿ç”¨æƒ…å†µ
usage = manager.get_current_usage()
print(f"ä½¿ç”¨ç‡: {usage['percent']}%")

# æ‰¹é‡å¯¼å…¥
sessions = [
    {"tokens": 5000, "event": "ä¼šè¯1"},
    {"tokens": 8000, "event": "ä¼šè¯2"},
]
result = manager.batch_import_sessions(sessions)
```

### REST API

```bash
# è®°å½•Tokenï¼ˆæ‰‹åŠ¨åŒæ­¥ï¼‰
curl -X POST http://localhost:8877/api/record_token_usage \
  -H "Content-Type: application/json" \
  -d '{
    "tokens": 350000,
    "event": "æ‰‹åŠ¨åŒæ­¥",
    "conversation_id": "manual-001",
    "sync_type": "manual"
  }'

# å“åº”
{
  "success": true,
  "message": "Tokenä½¿ç”¨å·²è®°å½•",
  "total_used": 350000,
  "increment": 15000
}
```

---

## ğŸ“ å·¥ä½œåŸç†

### æ‰‹åŠ¨åŒæ­¥ï¼ˆManual Syncï¼‰

- **è¾“å…¥**: å½“å‰æ€»Tokenå€¼ï¼ˆä»CursorçŠ¶æ€æ ï¼‰
- **è®¡ç®—**: `å¢é‡ = å½“å‰å€¼ - ä¸Šæ¬¡è®°å½•å€¼`
- **æ›´æ–°**: `æ€»ä½¿ç”¨ = å½“å‰å€¼`
- **è®°å½•**: ä¿å­˜å¢é‡åˆ°ä¼šè¯å†å²

### è‡ªåŠ¨ä¼°ç®—ï¼ˆAuto Estimateï¼‰

- **ä½¿ç”¨**: `tiktoken` åº“ï¼ˆOpenAIå®˜æ–¹Tokenè®¡æ•°ï¼‰
- **ç²¾åº¦**: Â±5% è¯¯å·®
- **è®¡ç®—**: 
  - ä¸­æ–‡ï¼šçº¦1.5 token/å­—
  - è‹±æ–‡ï¼šçº¦1.3 token/è¯
  - ä»£ç ï¼šç²¾ç¡®è®¡ç®—

### æ•°æ®å­˜å‚¨

```
automation-data/
  â””â”€â”€ architect_monitor.json    # Tokenä½¿ç”¨æ•°æ®
      â”œâ”€â”€ token_usage
      â”‚   â”œâ”€â”€ used: 350000
      â”‚   â”œâ”€â”€ total: 1000000
      â”‚   â””â”€â”€ sessions: [...]   # æœ€è¿‘100æ¡ä¼šè¯
      â””â”€â”€ last_updated
```

---

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ¯æ¬¡å¯¹è¯åæ‰‹åŠ¨åŒæ­¥

```bash
# 1. å®Œæˆä¸€æ¬¡é•¿å¯¹è¯
# 2. æŸ¥çœ‹CursorçŠ¶æ€æ ï¼š350,000 tokens
# 3. åŒå‡» ğŸ”„å¿«é€ŸåŒæ­¥Token.bat
# 4. Dashboardè‡ªåŠ¨æ›´æ–°
```

### åœºæ™¯2ï¼šé¡¹ç›®é˜¶æ®µå®Œæˆæ—¶è®°å½•

```bash
python packages/shared-utils/token_sync.py record 450000 "Phase 1 å®Œæˆ"
```

### åœºæ™¯3ï¼šæ‰¹é‡å¯¼å…¥å†å²è®°å½•

```python
from packages.shared_utils.token_sync import TokenSyncManager

manager = TokenSyncManager()
sessions = [
    {"tokens": 50000, "event": "é¡¹ç›®åˆå§‹åŒ–", "timestamp": "2025-11-01 10:00:00"},
    {"tokens": 80000, "event": "Phase 1å¼€å‘", "timestamp": "2025-11-05 15:30:00"},
    {"tokens": 120000, "event": "Phase 2å¼€å‘", "timestamp": "2025-11-10 18:00:00"},
]
manager.batch_import_sessions(sessions)
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Tokenå€¼æ¥æº

- âœ… ä½¿ç”¨Cursorå³ä¸‹è§’çŠ¶æ€æ çš„çœŸå®å€¼
- âŒ ä¸è¦ä¼°ç®—æˆ–çŒœæµ‹
- âŒ ä¸è¦ä½¿ç”¨å…¶ä»–å·¥å…·çš„ç»Ÿè®¡

### 2. åŒæ­¥é¢‘ç‡

- **æ¨è**: æ¯æ¬¡é•¿å¯¹è¯ååŒæ­¥ä¸€æ¬¡
- **æœ€å°‘**: æ¯ä¸ªå·¥ä½œæ—¥ç»“æŸæ—¶åŒæ­¥
- **æœ€å¤š**: å®æ—¶åŒæ­¥ï¼ˆæ¯æ¬¡å¯¹è¯ï¼‰

### 3. å¢é‡è®¡ç®—

- ç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—å¢é‡
- å¦‚æœè¾“å…¥å€¼å°äºä¸Šæ¬¡è®°å½•ï¼Œä¼šç›´æ¥è®¾ç½®ä¸ºå½“å‰å€¼
- æ”¯æŒæ‰‹åŠ¨ä¿®æ­£é”™è¯¯çš„è®°å½•

### 4. ç²¾ç¡®åº¦

- **æ‰‹åŠ¨åŒæ­¥**: 100% ç²¾ç¡®ï¼ˆåŸºäºCursorçœŸå®å€¼ï¼‰
- **è‡ªåŠ¨ä¼°ç®—**: çº¦95% ç²¾ç¡®ï¼ˆåŸºäºtiktokenï¼‰
- **å»ºè®®**: ä¸»è¦ä½¿ç”¨æ‰‹åŠ¨åŒæ­¥ï¼Œè‡ªåŠ¨ä¼°ç®—ä½œä¸ºè¾…åŠ©

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸èƒ½è‡ªåŠ¨è¯»å–CursorçŠ¶æ€æ ï¼Ÿ

A: Cursoræ²¡æœ‰æä¾›å…¬å¼€APIï¼ŒçŠ¶æ€æ ä¿¡æ¯æ— æ³•ç›´æ¥è®¿é—®ã€‚å› æ­¤é‡‡ç”¨æ‰‹åŠ¨åŒæ­¥æ–¹å¼ï¼Œä¿è¯å‡†ç¡®æ€§ã€‚

### Q2: æ‰‹åŠ¨åŒæ­¥ä¼šä¸ä¼šå¾ˆéº»çƒ¦ï¼Ÿ

A: ä¸ä¼šï¼åªéœ€ï¼š
1. å¤åˆ¶Tokenå€¼ï¼ˆ2ç§’ï¼‰
2. åŒå‡»è„šæœ¬ï¼ˆ1ç§’ï¼‰
3. å®Œæˆï¼

æ€»å…±3ç§’ï¼Œæ¯”å–å£æ°´è¿˜å¿« ğŸ˜„

### Q3: è‡ªåŠ¨ä¼°ç®—å‡†ç¡®å—ï¼Ÿ

A: ä½¿ç”¨OpenAIå®˜æ–¹çš„tiktokenåº“ï¼Œå‡†ç¡®åº¦çº¦95%ã€‚ä½†å»ºè®®ä»ä»¥æ‰‹åŠ¨åŒæ­¥ä¸ºä¸»ã€‚

### Q4: å¦‚ä½•æ‰¹é‡å¯¼å…¥å†å²è®°å½•ï¼Ÿ

A: ä½¿ç”¨Python APIçš„`batch_import_sessions()`æ–¹æ³•ï¼Œå‚è€ƒä¸Šé¢çš„ç¤ºä¾‹ä»£ç ã€‚

### Q5: Tokenæ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

A: `apps/dashboard/automation-data/architect_monitor.json`ï¼ŒJSONæ ¼å¼ï¼Œå¯ä»¥æ‰‹åŠ¨ç¼–è¾‘ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æŠ€æœ¯å®ç°**: `packages/shared-utils/token_sync.py`
- **APIæ–‡æ¡£**: `apps/dashboard/src/industrial_dashboard/dashboard.py`
- **UIå®ç°**: `apps/dashboard/src/industrial_dashboard/templates.py`
- **æµ‹è¯•ç”¨ä¾‹**: `tests/test_token_sync.py`

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] Dashboard UIæœ‰åŒæ­¥æŒ‰é’®
- [x] æ”¯æŒå¤šç§Tokenæ ¼å¼ï¼ˆæ•°å­—ã€é€—å·ã€Kã€ä¸‡ï¼‰
- [x] å¿«æ·è„šæœ¬å¯ç”¨ï¼ˆ.batæ–‡ä»¶ï¼‰
- [x] å‘½ä»¤è¡Œå·¥å…·å®Œæ•´
- [x] è‡ªåŠ¨ä¼°ç®—TokenåŠŸèƒ½
- [x] å¢é‡è®¡ç®—æ­£ç¡®
- [x] å®æ—¶åŒæ­¥åˆ°Dashboard
- [x] äº‹ä»¶æµè®°å½•
- [x] ä¼šè¯å†å²ä¿å­˜

---

**å®Œæˆæ—¶é—´**: 2025-11-18 21:00  
**å¼€å‘è€…**: Fullstack Engineer  
**éªŒæ”¶**: âœ… é€šè¿‡

---

ğŸ‰ TokenåŒæ­¥åŠŸèƒ½å·²å®Œæˆï¼ç°åœ¨å¯ä»¥å‡†ç¡®è¿½è¸ªTokenä½¿ç”¨æƒ…å†µäº†ï¼

