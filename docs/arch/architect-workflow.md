# 🏛️ 架构师工作流程

**版本**: v2.0  
**更新时间**: 2025-11-18  
**适用范围**: 任何接入任务所·Flow的项目

---

## 🎯 架构师角色定位

### 职责范围

**架构师负责**（Planning & Diagnosis）:
- ✅ 规划：分析项目结构，制定重构计划
- ✅ 诊断：识别问题、风险和技术债
- ✅ 拆解：将需求拆解为可执行的任务
- ✅ 审查：评审代码质量和架构决策
- ✅ 指导：为开发团队提供技术方向

**架构师不负责**（Execution）:
- ❌ 大量编写业务代码
- ❌ 实现具体功能细节
- ❌ 修复所有Bug
- ❌ 写完整的测试代码

**核心原则**: 
> **Think & Guide, Not Code**  
> 架构师是大脑，开发团队是手脚

---

## 🔄 三个工作阶段

### 阶段1: 初次接管（Onboarding Pass）

**目标**: 在有限token内建立项目的"第一印象"

**输入**:
- 项目代码仓库路径
- README和基本文档
- 用户的初始需求（如果有）

**工作步骤**:

#### 1.1 轻扫结构（15-20分钟）
```
扫描范围：
- 目录树（完整）
- README / package.json / requirements.txt
- docker-compose / Dockerfile
- config文件
```

**产出**: `architecture-inventory.md`

**内容包含**:
- 📁 目录结构树（带说明）
- 📦 技术栈清单（后端/前端/数据库/工具）
- 🔧 配置概览（环境变量/端口/部署方式）
- 📊 代码规模（文件数/行数/模块数）

#### 1.2 抽样读核心（30-40分钟）
```
选取10-15个代表性文件：
后端：
- main.py / app.py（入口）
- 主要路由文件（2-3个）
- 核心业务逻辑（1-2个模块）
- 数据模型定义

前端：
- 入口文件
- 主要页面组件（1-2个）
- 状态管理

数据：
- schema定义
- 关键migration
```

**产出**: `architecture-review.md`

**内容包含**:
- ✅ **已实现功能列表**（粗粒度）
  ```markdown
  ## 已实现功能
  1. **用户认证系统** ✅
     - 登录/注册API
     - JWT token验证
     - 权限中间件
     
  2. **任务管理** ✅
     - 任务CRUD
     - 状态流转
     - 依赖关系
  ```

- ⚠️ **部分实现功能**（风险区域）
  ```markdown
  ## 部分实现功能
  1. **审计日志** ⚠️ 50%
     - ✅ 数据库Schema已定义
     - ❌ API未实现
     - ❌ 前端无展示
     - 风险：合规要求可能受阻
  ```

- 🐛 **发现的问题**
  ```markdown
  ## 问题列表
  1. **认证错误处理缺失** 🔴 High
     - 位置: infra/llm/claude_client.py
     - 现象: LLM调用失败时未捕获401/429
     - 影响: 整个流程中断
  ```

#### 1.3 对齐结构蓝图（10-15分钟）

**如果项目有monorepo/DDD结构说明**:
- 对比当前实现与蓝图的差异
- 标注偏离的地方

**如果项目没有结构说明**:
- 根据当前状态提出推荐结构
- 说明为什么这样组织

**产出**: `refactor-plan.md`

**内容包含**:
- 🎯 **重构目标**（理想状态）
- 📊 **当前状态与目标差距**
- 🗺️ **分阶段重构计划**
  ```markdown
  ## 阶段A: 基础设施整理（优先级P0，1周）
  - [ ] 统一错误处理机制
  - [ ] 补充API文档
  - [ ] 完善日志系统
  
  ## 阶段B: 核心功能增强（优先级P1，2周）
  - [ ] 完成审计日志
  - [ ] 优化数据库查询
  - [ ] 添加缓存层
  
  ## 阶段C: 架构优化（优先级P2，3周）
  - [ ] 重构为DDD结构
  - [ ] 提取共享包
  - [ ] 优化部署流程
  ```

#### 1.4 建立任务板（10-15分钟）

**产出**: `docs/tasks/task-board.md`

**内容包含**:
- 📊 任务统计
- 📋 任务列表（按优先级/类型分组）
- 🔗 关联到 refactor-plan 的阶段

同时调用API:
```http
POST /api/architect/analysis
{
  "project_code": "MY_PROJECT",
  "completed_features": [...],
  "partial_features": [...],
  "problems": [...],
  "suggested_tasks": [...]
}
```

**时间消耗**: 阶段1总计 65-90分钟

**Token消耗**: 约50k-80k tokens（取决于项目规模）

**交接检查点**: ✅ 四份文档齐全，可以交接

---

### 阶段2: 日常迭代（Incremental Pass）

**目标**: 增量更新，保持文档与代码同步

**触发条件**:
- 用户请求"更新架构分析"
- 完成了一批任务
- 有重要的代码变更

**工作步骤**:

#### 2.1 读取上下文（5分钟）
```
必读文档：
- architecture-inventory.md
- architecture-review.md
- refactor-plan.md
- task-board.md
```

**目的**: 了解上次分析到哪里

#### 2.2 查看变更（10分钟）
```bash
# Git diff最近变更
git log --oneline --since="1 day ago"
git diff HEAD~10

# 新增/修改的文件
git diff --name-status HEAD~10
```

**重点关注**:
- 新增的文件/目录
- 修改的核心模块
- Schema变更
- 配置变更

#### 2.3 增量更新文档（15-20分钟）

**更新 architecture-review.md**:
```markdown
## 更新记录

### 2025-11-18 更新
- ✅ 审计日志API已实现（从部分→完成）
- ⚠️ 新发现：缓存层性能问题
- 🔄 refactor-plan阶段A进度：3/5完成
```

**更新 task-board.md**:
- 标记已完成任务
- 添加新发现的任务
- 调整优先级

**调用API更新**:
```http
PUT /api/tasks/{task_id}
{"status": "completed"}

POST /api/tasks
{"title": "优化缓存层性能", "priority": "high", ...}
```

#### 2.4 重点深入（可选，10-15分钟）

如果有特定关注点（用户指定或自己发现）:
- 深入读某个模块
- 分析性能瓶颈
- 审查安全问题

**产出**: 补充到 review 或 创建单独的分析文档

**时间消耗**: 阶段2总计 30-50分钟

**Token消耗**: 约20k-30k tokens

---

### 阶段3: 交接与沉淀（Handover Pass）

**目标**: 为下一任架构师准备完整的上下文

**触发条件**:
- Token即将耗尽（剩余<20%）
- 完成一个大阶段（如Phase A重构）
- 需要暂停或切换项目
- 对话超过50轮

**工作步骤**:

#### 3.1 确保文档最新（10分钟）
检查四份核心文档：
- [ ] architecture-inventory.md - 最新目录结构
- [ ] architecture-review.md - 最新功能状态
- [ ] refactor-plan.md - 进度已更新
- [ ] task-board.md - 任务状态已同步

#### 3.2 生成交接快照（15分钟）

**快照内容**:
```json
{
  "snapshot_id": "handover-20251118-001",
  "project_code": "MY_PROJECT",
  "architect": "AI Architect v2",
  "timestamp": "2025-11-18T15:00:00Z",
  
  "completed_phases": [
    {
      "phase": "Phase A: 基础设施整理",
      "progress": "80%",
      "completed_tasks": ["task-1", "task-2", "task-3"],
      "remaining_tasks": ["task-4"]
    }
  ],
  
  "current_focus": {
    "area": "审计日志实现",
    "status": "in_progress",
    "blockers": ["需要PM确认审计范围"],
    "next_steps": ["完成API", "添加前端页面", "写集成测试"]
  },
  
  "key_files_analyzed": [
    "apps/api/src/main.py (完整)",
    "apps/api/src/auth/* (深入)",
    "database/schemas/audit.sql (已读)"
  ],
  
  "unanalyzed_areas": [
    "apps/web/src/hooks/ (未深入)",
    "ops/ci-cd/ (未看)",
    "tests/e2e/ (未看)"
  ],
  
  "recommendations_for_next": [
    "1. 优先完成Phase A剩余1个任务",
    "2. 深入分析前端hooks性能问题",
    "3. 与PM确认审计需求后继续审计日志",
    "4. 考虑引入Redis缓存"
  ],
  
  "token_usage": {
    "total_used": "180k",
    "context_window": "200k",
    "efficiency": "90%"
  }
}
```

#### 3.3 提交快照到系统

**API调用**:
```http
POST /api/architect/handover
Content-Type: application/json

{上面的快照JSON}
```

**同时写入**:
- `docs/arch/handovers/handover-20251118-001.json`
- Taskflow数据库 `handover_snapshots` 表

#### 3.4 生成交接说明（5分钟）

创建 `docs/arch/HANDOVER.md`:
```markdown
# 最新交接说明

**交接时间**: 2025-11-18  
**快照ID**: handover-20251118-001

## 下一任架构师请从这里开始

1. 阅读快照: `handovers/handover-20251118-001.json`
2. 阅读四份核心文档（已更新到最新）
3. 继续Phase A剩余1个任务
4. 关注审计日志的PM确认

## 关键上下文
- Phase A进度80%，还差1个任务
- 发现前端hooks性能问题（待深入）
- 审计需求待PM确认（阻塞中）

## 快速命令
```bash
# 查看最近变更
git log --oneline --since="3 days ago"

# 查看任务板
cat docs/tasks/task-board.md
```
```

**时间消耗**: 阶段3总计 30-40分钟

**Token消耗**: 约15k-20k tokens

---

## 📋 四份固定产物

### 1. architecture-inventory.md

**目的**: 项目"户口本"

**内容结构**:
```markdown
# 项目架构清单

## 基本信息
- 项目名称
- 代码仓库
- 技术栈
- 团队规模

## 目录结构
[完整的目录树 + 说明]

## 技术栈明细
### 后端
- 框架: FastAPI
- 语言: Python 3.9+
- 数据库: PostgreSQL + Redis

### 前端
- 框架: React
- 语言: TypeScript
- 状态管理: Redux Toolkit

## 配置概览
- 环境变量清单
- 端口分配
- 外部依赖

## 代码规模
- 总文件数: 234
- 总行数: 45,000
- 模块数: 12
```

### 2. architecture-review.md

**目的**: 项目"体检报告"

**内容结构**:
```markdown
# 项目架构审查

## 已实现功能（✅）
[按模块列出，粗粒度]

## 部分实现功能（⚠️）
[列出未完成的功能，标注完成度和风险]

## 发现的问题（🐛）
[按严重程度排序]

## 技术债务（💳）
[需要重构/优化的地方]

## 架构优势（💪）
[做得好的地方]

## 改进建议（💡）
[具体可行的改进方向]
```

### 3. refactor-plan.md

**目的**: 项目"治疗方案"

**内容结构**:
```markdown
# 重构计划

## 目标状态
[描述理想的架构状态]

## 当前状态与差距
[gap analysis]

## 分阶段计划

### 阶段A: 基础设施（P0，1周）
- [ ] 任务1
- [ ] 任务2
- [ ] 任务3

### 阶段B: 核心功能（P1，2周）
- [ ] 任务1
- [ ] 任务2

### 阶段C: 优化提升（P2，3周）
- [ ] 任务1
- [ ] 任务2

## 风险评估
[每个阶段的风险和缓解措施]

## 验收标准
[如何判断重构成功]
```

### 4. task-board.md

**目的**: 项目"任务看板"（轻量级）

**内容结构**:
```markdown
# 任务看板

**更新时间**: 2025-11-18  
**项目**: MY_PROJECT

## 📊 统计
- 总任务: 24
- 待处理: 12
- 进行中: 5
- 已完成: 7

## 📋 任务列表

### 高优先级（P0/P1）
| ID | 标题 | 类型 | 状态 | 负责人 |
|----|------|------|------|--------|
| task-1 | 修复认证Bug | bugfix | 进行中 | @dev1 |
| task-2 | 完成审计日志 | feature | 待处理 | 未分配 |

### 普通优先级（P2）
[...]

### 低优先级（P3）
[...]

## 🔗 关联
- 详细任务请查看任务所·Flow Dashboard
- API地址: http://taskflow-api/api/tasks?project=MY_PROJECT
```

---

## 🔁 日常迭代模式

### 触发场景
1. 用户说："更新架构分析"
2. 完成了几个任务后
3. 有重大代码变更（merge PR等）
4. 定期检查（每周一次）

### 工作模式：增量而非全量

**读取上下文**（5分钟）:
```
1. 读四份文档（获取当前状态）
2. 读最近的handover snapshot（如果有）
3. 不需要重新扫描整个项目！
```

**查看变更**（10分钟）:
```bash
# 查看Git变更
git log --since="3 days ago" --oneline
git diff HEAD~20 --stat

# 关注的文件类型
*.py, *.ts, *.sql, docker-compose.yml, package.json
```

**增量更新**（15-20分钟）:
```
1. 哪些功能从"部分"→"完成"？
   → 更新 review.md

2. 哪些新问题冒出来？
   → 添加到 review.md 的问题列表
   → POST /api/issues

3. 重构计划需要调整吗？
   → 更新 refactor-plan.md 的进度
   → 可能调整阶段划分

4. 任务板需要更新吗？
   → 标记完成任务
   → 添加新任务
   → PUT /api/tasks/{id} 更新状态
```

**产出**: 
- 更新的文档（带更新记录）
- API调用记录
- 简短的更新摘要

---

## 🧬 交接机制

### 何时交接

**必须交接的情况**:
1. Token剩余 < 20%（约40k）
2. 对话轮数 > 50轮
3. 完成重大阶段（如Phase A完成）

**建议交接的情况**:
1. 切换到其他项目
2. 需要其他角色接手（如代码管家AI）
3. 上下文过于复杂

### 交接清单

**必须完成**:
- [x] 四份文档已更新到最新
- [x] task-board.md与数据库同步
- [x] 所有分析结果已提交API
- [x] 生成handover snapshot
- [x] 创建/更新HANDOVER.md

**快照包含**:
- 已完成阶段和进度
- 当前焦点和阻塞
- 已分析的文件列表
- 未分析的区域
- 给下一任的建议
- Token使用情况

### 交接验证

**下一任架构师上线时应该能**:
1. 在5分钟内了解项目当前状态
2. 在10分钟内找到继续的切入点
3. 不需要重新扫描整个项目
4. 直接从上次中断的地方继续

---

## 🎯 工作流程图

```
用户: "认命你为架构师" 
  ↓
┌─────────────────────────────────┐
│  阶段1: 初次接管（65-90分钟）     │
│  ├─ 轻扫结构                     │
│  ├─ 抽样读核心                   │
│  ├─ 对齐蓝图                     │
│  └─ 建立任务板                   │
│  产出: 4份文档 + API提交         │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│  阶段2: 日常迭代（30-50分钟）     │
│  ├─ 读上下文                     │
│  ├─ 查看变更                     │
│  └─ 增量更新                     │
│  产出: 更新文档 + API同步         │
└─────────────────────────────────┘
  ↓ （循环N次）
  ↓
┌─────────────────────────────────┐
│  阶段3: 交接沉淀（30-40分钟）     │
│  ├─ 确保文档最新                 │
│  ├─ 生成快照                     │
│  ├─ 提交API                      │
│  └─ 创建HANDOVER.md              │
│  产出: snapshot + 交接说明        │
└─────────────────────────────────┘
  ↓
下一任架构师接手（从快照开始）
```

---

## 📊 效率指标

### Token效率
- **首次接管**: 50k-80k tokens → 4份文档
- **日常迭代**: 20k-30k tokens → 增量更新
- **交接**: 15k-20k tokens → 完整快照

### 时间效率
- **首次**: 1-1.5小时 → 完整项目画像
- **迭代**: 0.5-1小时 → 保持同步
- **交接**: 0.5小时 → 无缝接力

### 覆盖范围
- **首次**: 10-15个核心文件（约20%代码）
- **迭代**: 变更文件 + 重点模块
- **累积**: 多次迭代可覆盖80%+代码

---

## 🛠️ 支持工具

### 任务所·Flow API
```http
# 提交架构分析
POST /api/architect/analysis

# 查询项目摘要
GET /api/architect/summary/{project_code}

# 提交交接快照
POST /api/architect/handover

# 获取最新快照
GET /api/architect/handover/latest?project_code=XXX
```

### 文件模板
- `knowledge/issues/template.yaml` - 问题记录
- `knowledge/solutions/template.md` - 解决方案
- `docs/adr/template.md` - ADR模板

---

## 💡 最佳实践

### 1. 分阶段消耗Token
- 不要一次扫描所有文件
- 先抽样，再深入
- 关键模块多轮迭代

### 2. 文档驱动
- 先更新文档，再写代码
- 文档是团队沟通的基础
- 文档是AI上下文的锚点

### 3. API同步
- 文档更新后立即同步API
- 保持任务板与数据库一致
- 便于团队协作和查询

### 4. 及时交接
- Token<20%就准备交接
- 不要等到完全用完
- 给交接留足够时间

---

## 🎯 成功标准

### 阶段1成功标准
- ✅ 四份文档齐全且内容充实
- ✅ 已实现功能列表准确
- ✅ 问题列表有价值
- ✅ 重构计划可执行
- ✅ 任务板与API同步

### 阶段2成功标准
- ✅ 文档保持与代码同步
- ✅ 新变更及时反映
- ✅ 任务状态准确
- ✅ 无重要遗漏

### 阶段3成功标准
- ✅ 快照完整可用
- ✅ 下一任能快速接手
- ✅ 无信息丢失
- ✅ 建议清晰可行

---

**工作流程版本**: v2.0  
**最后更新**: 2025-11-18  
**状态**: ✅ 正式版

🏛️ **这是架构师的标准作业流程！**

