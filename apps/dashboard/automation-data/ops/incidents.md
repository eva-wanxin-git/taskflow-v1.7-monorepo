# 故障记录

## 2025-11-19 Dashboard端口冲突问题

**时间**: 2025-11-18 22:50 - 2025-11-19 00:20  
**持续时间**: 90分钟  
**影响**: Dashboard需要多次切换端口才能显示最新内容  
**严重等级**: P2 (Medium)

### 问题描述
在更新Dashboard代码和数据后，浏览器持续显示旧内容，即使强制刷新(Ctrl+F5)也无效。

### 根因分析

**主要原因：浏览器缓存机制**
- 浏览器对localhost的缓存非常激进
- Service Worker可能缓存了整个应用
- 即使强制刷新也可能读取缓存的API响应

**次要原因：端口复用**
- 同一端口重启服务
- 浏览器认为是同一个应用
- 继续使用缓存数据

### 解决过程

**尝试1：8870端口** ❌
- 启动成功，但浏览器显示空白
- 原因：数据库Schema不兼容

**尝试2：8871端口** ⚠️
- 修复Schema后显示部分内容
- 但功能清单仍然空白
- 原因：API重复定义 + 浏览器缓存

**尝试3：8872端口** ⚠️
- 修复API后理论上应该正常
- 但用户反馈仍然看到旧内容
- 原因：浏览器缓存

**尝试4：8873端口** ✅
- 全新端口，浏览器无缓存
- 所有数据显示正确

### 完整端口变更历史
```
8870 (初始) → Schema不兼容
   ↓
8871 (修复Schema) → API重复+缓存
   ↓
8872 (修复API) → 缓存问题
   ↓
8873 (换端口) → ✅ 成功
```

### 解决方案

**短期方案（已实施）**：
- 每次重大更新换新端口
- 端口范围：8870-8899（30个可用）
- 避免浏览器缓存问题

**长期方案（建议）**：
1. **添加版本号到URL**
   ```
   /static/app.js?v=1.7.0
   ```

2. **设置HTTP头禁用缓存**
   ```python
   response.headers["Cache-Control"] = "no-cache, no-store, must-revalidate"
   response.headers["Pragma"] = "no-cache"
   response.headers["Expires"] = "0"
   ```

3. **使用Service Worker版本控制**
   ```javascript
   const CACHE_VERSION = 'v1.7.0';
   // 新版本自动清理旧缓存
   ```

4. **提供清除缓存按钮**
   - Dashboard添加"清除缓存"按钮
   - 调用`caches.delete()`清理

### 预防措施

**开发环境**：
- 开发时禁用浏览器缓存（F12 → Network → Disable cache）
- 使用隐私模式测试
- 每次重大更新换端口

**生产环境**：
- 必须实施长期方案（HTTP头+版本号）
- 配置CDN的缓存策略
- 监控缓存命中率

### 教训

1. **localhost也会有缓存问题**
   - 不要以为localhost不缓存
   - 测试时使用隐私模式
   
2. **强制刷新不一定有效**
   - Ctrl+F5只清理页面缓存
   - 不一定清理API响应缓存
   - Service Worker缓存更顽固

3. **端口变更是有效的临时方案**
   - 新端口=新应用
   - 浏览器不会使用缓存
   - 但不能作为长期方案

### 运维记录

| 时间 | 操作 | 端口 | 结果 |
|------|------|------|------|
| 22:50 | 首次启动 | 8870 | ❌ Schema不兼容 |
| 23:00 | 修复Schema后重启 | 8871 | ⚠️ API重复 |
| 23:15 | 修复API后重启 | 8871 | ⚠️ 缓存问题 |
| 23:58 | 添加任务渲染 | 8872 | ⚠️ 端口占用 |
| 00:10 | 修复冲突数据 | 8872 | ⚠️ 缓存问题 |
| 00:20 | 换端口避免缓存 | 8873 | ✅ 成功 |

### 性能影响
- 端口变更：0影响
- 数据迁移：0影响
- 用户体验：需要记住新端口

### 后续监控
- 监控8873端口稳定性
- 观察是否还有缓存问题
- 如有问题继续换端口（8874+）

---

## 2025-11-18 Dashboard显示空白问题

**时间**: 2025-11-18 22:50  
**影响**: Dashboard无法显示任务数据  
**持续时间**: 25分钟  
**严重等级**: P1 (High)

### 问题描述
Dashboard启动后页面空白，控制台无明显错误

### 根因分析
数据库Schema与StateManager期望字段不匹配：
- StateManager期望: depends_on, blocked_by, revision_count等
- v1.7数据库: 只有基础字段
- 导致: _task_dict_to_model()抛出KeyError

### 解决方案
1. 添加6个必需字段到tasks表
2. 从task_dependencies表同步数据到depends_on字段
3. 修复状态值格式(大写→小写)

### 预防措施
- 数据库Schema变更必须同步更新StateManager
- 添加Schema版本检查
- 迁移脚本自动处理兼容性

### 教训
Monorepo迁移时需要确保数据层的完整兼容
