# 📤 派发给全栈工程师·李明 - 集成部署P0任务

**派发时间**: 2025-11-19 03:30  
**派发人**: AI Architect (Expert Level)  
**接收人**: 全栈工程师·李明  
**优先级**: 🔴 P0 Critical  
**任务类型**: 🚀 集成部署

---

## 🎯 任务概述

李明，我们现在有**6个已完成的核心功能**需要集成到v1.7主线：

✅ **已完成的功能**:
1. REQ-001: 端口冲突解决
2. REQ-003: 对话历史库
3. REQ-006: Token实时同步
4. REQ-009: 任务三态流转
5. REQ-010: 全局事件流
6. REQ-011: 动态进度计算

**你的任务**: 将这些功能集成到v1.7，确保所有功能协同工作。

---

## 📋 开始前必读

```markdown
@taskflow-v1.7-monorepo/docs/ai/fullstack-engineer-system-prompt.md
@taskflow-v1.7-monorepo/📤派发给李明-集成部署P0任务.md
```

---

## 🚀 第一步：接收任务（必做！）

⚠️ **重要**: 看到此任务后，**立即执行**以下命令：

```bash
cd taskflow-v1.7-monorepo
python scripts/李明收到任务.py INTEGRATE-007
```

**这会做什么**:
- ✅ 更新任务状态: pending → in_progress
- ✅ 记录接收时间和执行人
- ✅ 记录到事件流
- ✅ Dashboard实时显示"⚙️ 进行中"

**⚠️ 不运行此脚本，架构师看不到你的进度！**

---

## 🔴 P0任务清单（4个，11小时）

### INTEGRATE-001: 集成REQ-001端口冲突解决功能（2小时）

**任务ID**: INTEGRATE-001  
**工时**: 2小时  
**复杂度**: Low

#### 功能说明
REQ-001已实现：
- ✅ PortManager端口自动分配 (8870-8899)
- ✅ 缓存版本管理 (dashboard_version.json)
- ✅ 清除缓存功能

#### 你的任务
1. **验证Dashboard显示"清除缓存"按钮**
   - 检查Dashboard UI是否有清除缓存按钮
   - 如果没有，添加按钮到顶部工具栏
   
2. **测试端口自动分配**
   ```python
   # 测试端口分配
   from packages.shared_utils.port_manager import PortManager
   
   pm = PortManager()
   port = pm.get_available_port("test_project")
   print(f"分配端口: {port}")  # 应该在8870-8899范围
   ```

3. **验证缓存版本控制**
   - 检查`automation-data/dashboard_version.json`
   - 确认版本号更新机制

4. **集成到启动脚本**
   - 确保`启动Dashboard.bat`使用端口管理器
   - 添加缓存清除选项

#### 验收标准
- [ ] Dashboard有"清除缓存"按钮且可用
- [ ] 点击按钮后清除浏览器缓存
- [ ] 端口自动分配测试通过
- [ ] 缓存版本显示正确
- [ ] 启动脚本集成完成

#### 参考文档
- `REQ-001-完成报告.md`
- `packages/shared-utils/port_manager.py`
- `apps/dashboard/automation-data/dashboard_version.json`

---

### INTEGRATE-002: 集成REQ-003对话历史库功能（3小时）

**任务ID**: INTEGRATE-002  
**工时**: 3小时  
**复杂度**: Medium

#### 功能说明
REQ-003已实现：
- ✅ 会话管理UI (4个Tab)
- ✅ 会话CRUD API (11个端点)
- ✅ 会话统计功能
- ✅ 会话标签管理

#### 你的任务
1. **部署会话管理API**
   ```python
   # 在apps/api/src/main.py中添加路由
   from .routes import conversation_history
   
   app.include_router(conversation_history.router)
   ```

2. **集成会话管理UI**
   - 添加"对话历史"Tab到Dashboard
   - 集成4个子Tab（会话列表/统计/搜索/标签）
   
3. **测试API端点**
   ```bash
   # 测试会话创建
   curl -X POST http://localhost:8870/api/conversations \
     -H "Content-Type: application/json" \
     -d '{
       "title": "测试会话",
       "project_id": "TASKFLOW",
       "model": "claude-3-5-sonnet"
     }'
   
   # 测试会话查询
   curl http://localhost:8870/api/conversations
   ```

4. **集成Session Memory MCP**
   - 验证与Session Memory的连接
   - 测试会话同步功能

5. **UI集成**
   - 在Dashboard中添加"对话历史"入口
   - 测试会话创建、查看、编辑、删除

#### 验收标准
- [ ] 11个API端点全部可用并测试通过
- [ ] 会话管理UI完整集成到Dashboard
- [ ] 会话CRUD功能正常
- [ ] 统计数据准确显示
- [ ] Session Memory MCP连接正常
- [ ] UI响应流畅（无卡顿）

#### 参考文档
- `✅REQ-003-对话历史库功能-完成报告.md`
- `docs/features/conversation-history-library.md`
- `packages/core-domain/src/services/conversation_service.py`

---

### INTEGRATE-003: 集成REQ-006 Token实时同步功能（2小时）

**任务ID**: INTEGRATE-003  
**工时**: 2小时  
**复杂度**: Low

#### 功能说明
REQ-006已实现：
- ✅ 4种同步方式（Cursor状态栏/手动输入/历史推算/窗口检测）
- ✅ Token显示组件
- ✅ 对话历史库集成
- ✅ 一键同步按钮

#### 你的任务
1. **验证Dashboard显示Token**
   - 检查Dashboard顶部是否显示Token信息
   - 格式：`🔢 Token: 320K/1M (32.0%)`

2. **测试4种同步方式**
   ```python
   # 方式1: 从Cursor状态栏读取
   # 方式2: 手动输入
   # 方式3: 从历史推算
   # 方式4: 窗口检测
   
   # 测试每种方式的可用性
   ```

3. **集成对话历史库联动**
   - Token更新时自动记录到对话历史
   - 显示Token历史趋势

4. **添加一键同步按钮**
   - 在Dashboard添加"同步Token"按钮
   - 点击后弹出同步选项

5. **测试自动更新**
   - 验证Token每15秒自动刷新

#### 验收标准
- [ ] Dashboard显示Token实时数据
- [ ] 4种同步方式全部可用
- [ ] Token历史记录正确
- [ ] 与对话历史库联动正常
- [ ] 一键同步按钮工作正常
- [ ] 自动更新机制正常

#### 参考文档
- `✅REQ-006-Token同步与对话历史库-完成报告.md`
- `docs/REQ-006-Token同步使用指南.md`

---

### INTEGRATE-007: E2E集成测试（4小时）

**任务ID**: INTEGRATE-007  
**工时**: 4小时  
**复杂度**: High

#### 测试范围

**1. 完整工作流测试**
```python
# test_workflow.py

def test_complete_workflow():
    """测试完整工作流：创建→执行→审查→完成"""
    
    # 1. 架构师创建任务
    task = create_task({
        "title": "测试任务",
        "description": "集成测试",
        "assigned_to": "fullstack-engineer"
    })
    assert task.status == "pending"
    
    # 2. 工程师领取任务
    claim_task(task.id)
    assert task.status == "in_progress"
    
    # 3. 工程师提交完成
    complete_task(task.id)
    assert task.status == "completed"
    
    # 4. 验证事件流记录
    events = get_events(task.id)
    assert len(events) >= 3  # 创建、领取、完成
```

**2. 数据一致性测试**
```python
def test_data_consistency():
    """测试Dashboard显示与数据库一致"""
    
    # 从数据库查询
    db_stats = query_database_stats()
    
    # 从API查询
    api_stats = get_api_stats()
    
    # 验证一致性
    assert db_stats.total == api_stats.total
    assert db_stats.completed == api_stats.completed
    assert db_stats.progress == api_stats.progress
```

**3. 性能测试**
```python
def test_performance():
    """测试性能指标"""
    
    # 测试1: 任务列表加载
    start = time.time()
    tasks = load_tasks(limit=100)
    duration = time.time() - start
    assert duration < 2.0  # <2秒
    
    # 测试2: 事件流加载
    start = time.time()
    events = load_events(limit=100)
    duration = time.time() - start
    assert duration < 1.0  # <1秒
    
    # 测试3: Dashboard刷新
    start = time.time()
    refresh_dashboard()
    duration = time.time() - start
    assert duration < 1.5  # <1.5秒
```

**4. 跨功能集成测试**
```python
def test_cross_feature():
    """测试功能之间的联动"""
    
    # Token同步 + 对话历史库
    update_token(350000)
    conversation = get_latest_conversation()
    assert conversation.token_count == 350000
    
    # 任务流转 + 事件流
    change_task_status("TASK-001", "in_progress")
    events = get_events(type="status_change")
    assert len(events) > 0
    
    # 进度计算 + 统计展示
    complete_task("TASK-002")
    stats = get_statistics()
    assert stats.progress > 0
```

#### 验收标准
- [ ] 所有工作流测试通过（10+场景）
- [ ] 数据一致性100%
- [ ] 性能指标全部达标
- [ ] 跨功能集成正常
- [ ] 生成详细测试报告
- [ ] 无Critical或High Bug

#### 参考文档
- `tests/integration/`
- 所有REQ完成报告

---

## 🎯 执行顺序（推荐）

### Day 1上午（4小时）
1. INTEGRATE-001: 端口冲突（2h）
2. INTEGRATE-003: Token同步（2h）

### Day 1下午（5小时）
3. INTEGRATE-002: 对话历史库（3h）
4. 开始INTEGRATE-007: E2E测试（2h）

### Day 2上午（2小时）
5. 完成INTEGRATE-007: E2E测试（2h）

**总计**: 11小时 / 1.5天

---

## ✅ 完成标准

### 功能完整性
- [ ] 所有P0集成任务完成
- [ ] 所有已完成功能正常工作
- [ ] Dashboard完整展示所有功能

### 质量标准
- [ ] 无Critical Bug
- [ ] ≤2个High Bug
- [ ] E2E测试通过率≥95%
- [ ] 性能指标达标

### 文档标准
- [ ] 每个任务提交完成报告
- [ ] E2E测试报告详细
- [ ] 记录遇到的问题和解决方案

---

## 🧪 自测清单

**集成前检查**:
- [ ] 所有依赖的功能代码可访问
- [ ] 数据库Schema兼容
- [ ] API端点冲突检查

**集成后检查**:
- [ ] Dashboard启动无错误
- [ ] API服务正常响应
- [ ] 所有功能可通过UI访问
- [ ] 数据读写正常

**提交前检查**:
- [ ] 代码已提交Git
- [ ] 完成报告已编写
- [ ] 测试截图已保存
- [ ] 已自测所有功能

---

## 📚 重要提醒

### 1. 保持v1.6稳定
```
⚠️ v1.6是稳定版本，不要动！
✅ 所有集成只在v1.7中进行
✅ 如果v1.7出问题，可以回退到v1.6
```

### 2. 增量集成
```
✅ 一个功能一个功能集成
✅ 每集成一个就测试一次
❌ 不要一次性集成所有功能
```

### 3. 数据库备份
```bash
# 集成前备份数据库
cp database/data/tasks.db database/data/tasks.db.backup

# 如果出问题可以恢复
cp database/data/tasks.db.backup database/data/tasks.db
```

### 4. 提交完成报告
每个任务完成后，创建完成报告：
```markdown
# ✅ INTEGRATE-XXX 完成报告

## 任务概述
[简述]

## 实现摘要
[做了什么]

## 测试验证
[测试结果]

## 遇到的问题
[问题和解决方案]

## 完成度
100% ✅
```

---

## 🚀 开始执行

**启动指令**:
```bash
# 1. 备份数据库
cd taskflow-v1.7-monorepo
python scripts/备份数据库.py

# 2. 启动Dashboard
python apps/dashboard/start_dashboard.py

# 3. 访问Dashboard验证
# http://localhost:8877

# 4. 开始第一个任务
# INTEGRATE-001
```

---

## 📝 最后一步：提交完成（必做！）

每完成一个任务后，**立即执行**:

```bash
python scripts/李明提交完成.py <任务ID> --hours <实际工时>
```

**示例**:
```bash
# INTEGRATE-001完成后
python scripts/李明提交完成.py INTEGRATE-001 --hours 2

# INTEGRATE-007完成后  
python scripts/李明提交完成.py INTEGRATE-007 --hours 4
```

**这会做什么**:
- ✅ 更新任务状态: in_progress → completed
- ✅ 记录实际工时
- ✅ 记录到事件流
- ✅ Dashboard显示"📄 一键复制完成报告"按钮

**然后**: 在Dashboard点击按钮，复制完成报告，提交给架构师！

---

**李明，这是关键的集成部署任务！**

**集成完成后，v1.7将拥有完整的功能！** 🎉

**请按顺序执行，每完成一个提交一份报告！**

**遇到问题随时呼叫架构师！** 💪

---

**架构师**: AI Architect (Expert Level)  
**派发时间**: 2025-11-19 03:30  
**Dashboard**: http://localhost:8877  
**Token**: 330K/1M (33.0%)

📤 **集成部署任务已派发！等待李明执行！**

